# 行政事業レビュー サンキー図可視化WEBアプリケーション 設計書

## 1. プロジェクト概要

### 1.1 目的
RS System Pipelineで生成した行政事業レビュー（2014-2024年度）のCSVデータを、サンキー図で可視化し、予算の流れを市民が理解しやすくするWebアプリケーションを構築する。

### 1.2 参考プロジェクト
- [みらいまる見え政治資金](https://github.com/igomuni/marumie) - 政治資金のサンキー図可視化

### 1.3 データソース
- 保存先: `data/rs_system/year_YYYY/`
- 対象年度: 2014-2024年度
- 形式: RS System形式のCSV

## 2. データ構造分析

### 2.1 主要CSVファイル

#### 2.1.1 基本情報系
- `1-1_基本情報_組織情報.csv` - 担当組織の情報
- `1-2_基本情報_事業概要.csv` - 事業の概要説明
- `1-3_基本情報_政策・施策、法令等.csv` - 政策体系情報

#### 2.1.2 予算・執行系
- `2-1_予算・執行_サマリ.csv` - 予算と執行の集計情報
  - 重要カラム: 当初予算、補正予算、執行額、執行率

#### 2.1.3 支出先系（サンキー図の核心）
- `5-1_支出先_支出情報.csv` - 支出先ごとの詳細情報
  - 支出先ブロック番号、支出先名、支出額、契約方式等
- `5-2_支出先_支出ブロックのつながり.csv` - 支出の階層構造
  - 支出元ブロック → 支出先ブロックの関係性
  - 資金の流れを表現するための重要データ

### 2.2 データ構造の特徴

```
[府省庁] → [支出先ブロックA] → [支出先ブロックB] → [最終支出先]
                |                    |
                ↓                    ↓
            [企業A/団体A]        [再委託先]
```

## 3. 技術スタック

### 3.1 フロントエンド
- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **サンキー図ライブラリ**:
  - 候補1: D3.js (d3-sankey)
  - 候補2: Plotly.js
  - 候補3: Apache ECharts
  - 推奨: **D3.js** (カスタマイズ性が高く、みらいまる見え政治資金でも採用実績)

### 3.2 バックエンド
- **API**: Next.js API Routes
- **データ処理**: サーバーコンポーネント + loaders
- **データストレージ**:
  - 候補1: CSVファイルの直接読み込み（初期段階）
  - 候補2: SQLite/PostgreSQL（パフォーマンス最適化後）

### 3.3 デプロイ
- **ホスティング**: Vercel / Netlify
- **CI/CD**: GitHub Actions

## 4. 機能要件

### 4.1 コア機能

#### 4.1.1 年度選択機能
- 2014-2024年度のドロップダウン選択
- デフォルト: 最新年度（2024年度）

#### 4.1.2 府省庁選択機能
- 府省庁のフィルタリング
- 複数府省庁の比較表示（オプション）

#### 4.1.3 サンキー図表示
- **ノード**: 府省庁、支出先ブロック、支出先（企業・団体）
- **リンク**: 資金の流れ（太さは金額に比例）
- **インタラクティブ機能**:
  - ノードのホバー時に詳細情報表示
  - ノードのクリックでフォーカス
  - リンクのホバー時に金額表示
  - ズーム・パン機能

#### 4.1.4 詳細情報パネル
- 選択したノードの詳細情報表示
  - 事業名
  - 予算額・執行額・執行率
  - 支出先の数
  - 契約方式の内訳

#### 4.1.5 検索機能
- 事業名での検索
- 支出先名での検索

### 4.2 追加機能（後期フェーズ）

#### 4.2.1 年度比較機能
- 複数年度のデータを並べて表示
- 経年変化の可視化

#### 4.2.2 統計ダッシュボード
- 予算総額の推移
- 執行率の分布
- 支出先上位10社
- 一者応札率の推移

#### 4.2.3 データエクスポート
- CSV/JSONでのデータダウンロード
- サンキー図の画像エクスポート（PNG/SVG）

## 5. データ処理フロー

### 5.1 データ読み込み
```
1. ユーザーが年度を選択
2. サーバーサイドでCSVファイルを読み込み
   - 2-1_予算・執行_サマリ.csv
   - 5-1_支出先_支出情報.csv
   - 5-2_支出先_支出ブロックのつながり.csv
3. CSVをパースしてJSONに変換
4. サンキー図用のデータ構造に変換
```

### 5.2 サンキー図用データ構造
```typescript
interface SankeyNode {
  id: string;
  name: string;
  type: 'ministry' | 'block' | 'recipient';
  metadata?: {
    eventId?: string;
    eventName?: string;
    budget?: number;
    execution?: number;
    executionRate?: number;
  };
}

interface SankeyLink {
  source: string; // source node id
  target: string; // target node id
  value: number;  // 金額
  metadata?: {
    contractType?: string;
    bidders?: number;
  };
}

interface SankeyData {
  nodes: SankeyNode[];
  links: SankeyLink[];
}
```

### 5.3 データ変換アルゴリズム
```
1. 5-2_支出ブロックのつながり.csv から階層構造を構築
   - 担当組織 → 支出先ブロック → 再委託先
2. 5-1_支出先_支出情報.csv から金額情報を取得
3. ノードとリンクの重複を排除
4. 金額を集約してリンクのvalueを計算
```

## 6. UIデザイン

### 6.1 レイアウト
```
+----------------------------------------------------------+
|  Header: ロゴ | 年度選択 | 検索バー                      |
+----------------------------------------------------------+
|  Sidebar       |  Main Content (Sankey Diagram)          |
|  - 府省庁選択  |                                         |
|  - フィルター  |                                         |
|                |                                         |
|                |                                         |
+----------------+-----------------------------------------+
|  Footer: データソース情報 | GitHub リンク                 |
+----------------------------------------------------------+
```

### 6.2 カラーパレット
- 府省庁ごとに色分け（12色程度のカラーパレット）
- 推奨: Tailwind CSSのカラースケール

### 6.3 レスポンシブ対応
- デスクトップ優先（データ可視化の特性上）
- タブレット: サイドバーを折りたたみ
- モバイル: 基本機能のみ提供

## 7. ディレクトリ構成

```
rs_system_pipeline_marumie/
├── app/
│   ├── page.tsx                    # トップページ
│   ├── [year]/
│   │   └── page.tsx                # 年度別ページ
│   ├── api/
│   │   ├── data/
│   │   │   └── [year]/
│   │   │       └── route.ts        # データ取得API
│   │   └── search/
│   │       └── route.ts            # 検索API
│   └── layout.tsx
├── client/
│   ├── components/
│   │   ├── SankeyChart.tsx         # サンキー図コンポーネント
│   │   ├── YearSelector.tsx        # 年度選択
│   │   ├── MinistryFilter.tsx      # 府省庁フィルター
│   │   ├── DetailPanel.tsx         # 詳細情報パネル
│   │   └── SearchBar.tsx           # 検索バー
│   └── lib/
│       └── sankey-utils.ts         # サンキー図ヘルパー関数
├── server/
│   ├── loaders/
│   │   └── data-loader.ts          # CSVデータ読み込み
│   ├── lib/
│   │   ├── csv-parser.ts           # CSVパーサー
│   │   └── sankey-transformer.ts   # サンキーデータ変換
│   └── repositories/
│       └── csv-repository.ts       # CSVファイルアクセス
├── types/
│   ├── sankey.ts                   # サンキー図の型定義
│   └── rs-system.ts                # RSシステムデータの型定義
├── data/
│   └── rs_system/
│       └── year_YYYY/
│           └── *.csv               # 既存データ
├── docs/
│   └── 20251016_2043_行政事業レビューサンキー図可視化WEBアプリ設計.md
└── README.md
```

## 8. 実装フェーズ

### Phase 1: 基盤構築（1-2週間）
1. Next.jsプロジェクトのセットアップ
2. TypeScript型定義の作成
3. CSVパーサーの実装
4. データ変換ロジックの実装
5. 基本的なUIフレームの構築

### Phase 2: コア機能実装（2-3週間）
1. サンキー図コンポーネントの実装
2. 年度選択機能の実装
3. 府省庁フィルター機能の実装
4. データ取得APIの実装
5. インタラクティブ機能の実装

### Phase 3: UI/UX改善（1-2週間）
1. レスポンシブ対応
2. 詳細情報パネルの実装
3. 検索機能の実装
4. パフォーマンス最適化
5. アクセシビリティ対応

### Phase 4: 追加機能（オプション）
1. 年度比較機能
2. 統計ダッシュボード
3. データエクスポート機能
4. テストの追加

## 9. パフォーマンス考慮事項

### 9.1 データサイズ
- 5-1_支出先_支出情報.csv: 61.7MB (2024年度)
- 大規模データのため、適切な処理が必要

### 9.2 最適化戦略
1. **サーバーサイド処理**: CSVパースは全てサーバー側で実行
2. **データ集約**: 不要な詳細データをフィルタリング
3. **ページネーション/仮想化**: 大量ノードの場合は階層を分割表示
4. **キャッシング**: Next.jsのキャッシュ機能を活用
5. **遅延ロード**: 詳細情報は必要時のみ取得

## 10. セキュリティ考慮事項

### 10.1 データの取り扱い
- 公開データのため、特別な認証は不要
- ただし、適切なCORS設定とレート制限を実装

### 10.2 インプット検証
- 年度選択: 2014-2024の範囲チェック
- 検索クエリ: SQLインジェクション対策（将来DB化時）

## 11. 今後の拡張性

### 11.1 データベース移行
- パフォーマンス要件に応じて、PostgreSQL/SQLiteへの移行を検討
- Prismaを使った型安全なデータアクセス

### 11.2 マルチデータソース
- 政治資金データ（みらいまる見え）との統合
- 他の公開予算データとの連携

### 11.3 AI機能
- 予算配分の異常検出
- 支出パターンの自動分析
- 自然言語での質問応答

## 12. 参考資料

- [D3.js Sankey Diagram](https://observablehq.com/@d3/sankey)
- [Next.js App Router Documentation](https://nextjs.org/docs/app)
- [みらいまる見え政治資金 GitHub](https://github.com/igomuni/marumie)
- [RS System Pipeline GitHub](https://github.com/igomuni/rs_system_pipeline)
