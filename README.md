# 行政事業レビュー サンキー図可視化アプリ

行政事業レビューの公開データをサンキー図で可視化し、予算から執行までの資金の流れを理解しやすくするWebアプリケーションです。

## 特徴

- **サンキー図による可視化**: 府省庁から支出先への資金の流れを直感的に表示
- **年度選択**: 2014年度〜2024年度のデータを選択可能
- **府省庁フィルター**: 特定の府省庁に絞り込んで表示
- **インタラクティブ**: ノードやリンクにカーソルを当てると詳細情報を表示
- **統計情報**: 予算総額、執行額、執行率などの集計データを表示
- **事業レポート機能**:
  - 13,262事業の検索・閲覧
  - 事業名・府省庁での絞り込み検索（Fuse.js使用）
  - 事業ごとの年度別予算・執行額推移グラフ
  - 支出先Top10リスト
  - 支出先別の時系列推移グラフ
- **高速パフォーマンス**: ビルド時にデータを事前処理し、JSONとして最適化（80MB→112KB、約700倍の削減）

## 技術スタック

- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **データ可視化**: D3.js + d3-sankey, Recharts
- **データ処理**: csv-parse
- **検索**: Fuse.js（ファジー検索）

## プロジェクト構成

```
rs_system_pipeline_marumie/
├── app/                        # Next.js App Router
│   ├── [year]/                # 年度別ページ
│   ├── reports/               # 事業レポート
│   │   ├── [projectKey]/     # 事業詳細ページ
│   │   └── page.tsx          # 事業一覧ページ
│   ├── layout.tsx             # ルートレイアウト
│   └── page.tsx               # トップページ
├── client/                     # クライアントコンポーネント
│   ├── components/
│   │   ├── reports/           # レポート関連コンポーネント
│   │   │   ├── BudgetTrendChart.tsx          # 予算推移グラフ
│   │   │   ├── ExpenditureTopList.tsx        # 支出先Top10リスト
│   │   │   ├── ExpenditureTimeSeriesChart.tsx # 支出先時系列グラフ
│   │   │   ├── ProjectSearchInterface.tsx    # 検索インターフェース
│   │   │   └── ProjectTable.tsx              # 事業一覧テーブル
│   │   ├── SankeyChart.tsx    # サンキー図コンポーネント
│   │   └── YearSelector.tsx   # 年度選択コンポーネント
│   └── lib/
│       └── formatBudget.ts    # 金額フォーマット関数
├── server/                     # サーバーサイドロジック
│   ├── lib/
│   │   ├── csv-parser.ts      # CSVパーサー
│   │   └── sankey-transformer.ts  # データ変換
│   ├── repositories/
│   │   └── csv-repository.ts  # CSVファイルアクセス
│   └── loaders/
│       ├── data-loader.ts     # サンキー図データローダー
│       └── report-loader.ts   # レポートデータローダー
├── types/                      # TypeScript型定義
│   ├── rs-system.ts           # RSシステムデータの型
│   ├── sankey.ts              # サンキー図の型
│   └── report.ts              # レポートの型
├── scripts/                    # ビルドスクリプト
│   └── preprocess-data.ts     # データ前処理スクリプト
├── data/                       # 元データディレクトリ
│   └── rs_system/
│       └── year_YYYY/         # 年度別CSVデータ
├── public/data/                # 前処理済みJSONデータ
│   ├── year_YYYY/             # 年度別サンキー図データ
│   ├── projects/              # 事業詳細データ（13,262ファイル）
│   └── project-index.json     # 事業インデックス
└── docs/                       # ドキュメント
```

## セットアップ

### 前提条件

- Node.js 18以上
- npm または yarn

### インストール

1. リポジトリをクローン:

```bash
git clone https://github.com/igomuni/rs_system_pipeline_marumie.git
cd rs_system_pipeline_marumie
```

2. 依存関係をインストール:

```bash
npm install
```

3. データの確認:

`data/rs_system/` ディレクトリに年度別のCSVファイルが配置されていることを確認してください。

4. データの前処理（初回のみ）:

```bash
npm run preprocess
```

このコマンドにより、CSVデータが最適化されたJSON形式に変換されます（`public/data/`に保存）。

### 開発サーバーの起動

```bash
npm run dev
```

ブラウザで `http://localhost:3000` を開いてアプリケーションにアクセスできます。

## 使い方

### サンキー図表示

1. **トップページ**: 年度を選択して該当年度のページに移動
2. **年度別ページ**:
   - サンキー図で予算の流れを確認
   - サイドバーから府省庁でフィルタリング
   - ノードをクリックして詳細情報を表示
   - 年度セレクターで別の年度に切り替え

### 事業レポート機能

1. **事業一覧ページ** (`/reports`):
   - 13,262事業を一覧表示（20件ごとにページネーション）
   - 府省庁フィルターで絞り込み
   - 事業名検索（部分一致・ファジー検索対応）
   - 総予算は兆円/億円/万円で適切に表示

2. **事業詳細ページ** (`/reports/[projectKey]`):
   - 事業基本情報（府省庁、開始/終了年度、データ期間）
   - 予算・執行額の推移グラフ（2014〜2024年度）
   - 支出先Top10リスト（累計金額と年数）
   - 支出先別の時系列推移グラフ

## データソース

- [行政事業レビュー](https://www.gyoukaku.go.jp/)
- [RS System Pipeline](https://github.com/igomuni/rs_system_pipeline) - データ変換パイプライン

## ビルド

プロダクション用のビルド（データ前処理を含む）:

```bash
npm run build
npm run start
```

**注意**: `npm run build` は自動的に `npm run preprocess` を実行してデータを前処理します。

### パフォーマンス最適化

このアプリケーションは、ビルド時にデータを事前処理することで高速なパフォーマンスを実現しています：

- **元のCSVデータ**: 2024年度で約150MB（3ファイル合計）
- **最適化後のJSON**: 約11KB（99.99%の削減）
- **ページロード時間**: 数秒 → 数十ミリ秒

前処理では以下を行います：

**サンキー図データ生成**:
1. CSVファイルをパースしてJSONに変換
2. 対象年度（予算年度）のデータのみを抽出
3. 金額の単位を正規化（2014-2023年：百万円単位→円単位に変換、2024年：円単位のまま）
4. 府省庁ごとに予算を集約
5. サンキー図データを生成（左側：年度予算合計、右側：府省庁別予算）
6. 統計情報を事前計算（予算総額、執行額、執行率など）

**事業レポートデータ生成**:
1. 全年度（2014-2024）のCSVデータを読み込み
2. 事業名でプロジェクトを統合（事業IDは年度ごとに異なるため）
3. 事業開始/終了年度を1-2 CSVから取得（新しい年度を優先）
4. 年度ごとの予算・執行額を集約
5. 支出先データを集約し、Top10を抽出
6. 13,262事業のJSONファイルを個別に生成（MD5ハッシュをキーに使用）
7. 事業インデックスファイル（project-index.json）を生成

### データの年度間の違い

行政事業レビューのデータには年度によって以下の違いがあります：

- **2014-2024年度共通**:
  - ファイル命名: `{番号}_{年度}_{名称}.csv`
  - 例外: 2024年の1-2ファイルは `1-2_2024_基本情報_事業概要等.csv`（「等」付き）
  - CSVフィールド名: 半角 `(合計)` または全角 `（合計）` の括弧を使用（両方に対応）

- **金額単位の違い**:
  - 2014-2023年度: 百万円単位（前処理で円単位に正規化）
  - 2024年度: 円単位（1円単位）

- **特有のファイル**:
  - 5-2ファイル（支出ブロックのつながり）: 2024年度のみ存在

これらの違いは前処理スクリプトで自動的に処理されます。

## デプロイ

### Vercel

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https://github.com/igomuni/rs_system_pipeline_marumie)

### 手動デプロイ

1. ビルドを実行
2. `.next` ディレクトリと `data` ディレクトリをサーバーにアップロード
3. `npm run start` でサーバーを起動

## 参考プロジェクト

- [みらいまる見え政治資金](https://github.com/igomuni/marumie) - 政治資金のサンキー図可視化

## ライセンス

MIT

## コントリビューション

Issue や Pull Request を歓迎します。

## 主要な実装の特徴

### データの整合性対応

**2024年度データの複数行問題**:
- 2024年のCSVには同じ事業に対して複数行のデータが存在（予算データと前年度の執行データ）
- 空文字列の行が有効なデータを上書きしないよう、既存データがある場合は正の値のみで更新

**事業IDの年度間の不整合**:
- 同じ事業でも年度ごとに異なる事業IDが割り当てられている
- 事業名を主キーとして使用し、年度ごとの事業IDをマッピング
- URL用のキーとしてMD5ハッシュを使用（URLセーフで一定長）

**事業開始/終了年度の信頼性**:
- 古い年度（特に2014年）のデータは不正確な場合がある
- 新しい年度のデータを優先して取得するよう、降順でソート処理

## 設計ドキュメント

詳細な設計については以下をご覧ください:
- [サンキー図可視化設計書](docs/20251016_2043_行政事業レビューサンキー図可視化WEBアプリ設計.md)
- [事業レポート機能設計書](docs/20251021_0000_事業レポート機能設計.md)
